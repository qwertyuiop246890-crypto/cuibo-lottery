<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>CuiBo抽獎活動報名</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="page">
    <div class="card">
      <h1>抽獎活動報名</h1>
      <p class="desc">
        請輸入本次活動的訂單編號與 LINE 社群名稱。<br />
        系統會先幫你確認訂單是否符合本次抽獎資格。<br />
        如有多筆訂單只需輸入其中一筆即可，每人只有一次抽獎機會。
      </p>

      <form id="lotteryForm">
        <label class="field">
          <span class="label-text">訂單編號：</span>
          <input type="text" name="orderId" id="orderIdInput" required />
          <span id="orderStatus" class="hint"></span>
        </label>

        <label class="field">
          <span class="label-text">社群名稱：</span>
          <input type="text" name="snsName" id="snsNameInput" required />
        </label>

        <button type="submit" class="btn-primary">送出</button>
        <p id="submitStatus" class="status"></p>
      </form>
    </div>
  </div>

  <script>
    // TODO: 換成你的 Apps Script Web App URL
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzeTbGURdoztv_N2syJgI8mItBhQABnhYMuFd9NLRfZIZ4-jRLtpaDoM9Q5ca0i6-wm/exec";
    const ORDER_LIST_URL = "./orderIds.json";

    let validOrders = new Set();
    let ordersLoaded = false;

    const orderInput   = document.getElementById('orderIdInput');
    const snsInput     = document.getElementById('snsNameInput');
    const orderStatus  = document.getElementById('orderStatus');
    const form         = document.getElementById('lotteryForm');
    const submitStatus = document.getElementById('submitStatus');

    // 載入訂單清單
    async function loadOrders() {
      orderStatus.textContent = "訂單清單載入中…";
      try {
        const res = await fetch(ORDER_LIST_URL);
        const data = await res.json();
        if (Array.isArray(data.orders)) {
          validOrders = new Set(data.orders.map(String));
          ordersLoaded = true;
          orderStatus.textContent = "";
        } else {
          orderStatus.textContent = "訂單清單載入失敗，稍後再試。";
        }
      } catch (err) {
        console.error(err);
        orderStatus.textContent = "訂單清單載入失敗，稍後再試。";
      }
    }
    loadOrders();

    // 即時檢查訂單
    orderInput.addEventListener('input', () => {
      const value = orderInput.value.trim();
      if (!ordersLoaded || value === "") {
        orderStatus.textContent = "";
        return;
      }
      if (validOrders.has(value)) {
        orderStatus.textContent = "✅ 查到訂單，可以參加本次抽獎";
      } else {
        orderStatus.textContent = "⚠️ 找不到這張訂單，請確認是否輸入正確";
      }
    });

    // 送出表單
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      submitStatus.textContent = "";

      const orderId = orderInput.value.trim();
      const snsName = snsInput.value.trim();

      if (!ordersLoaded) {
        submitStatus.textContent = "訂單清單尚未載入完成，請稍後再試。";
        return;
      }
      if (!validOrders.has(orderId)) {
        submitStatus.textContent = "⚠️ 找不到這張訂單，請再次確認編號。";
        return;
      }
      if (!snsName) {
        submitStatus.textContent = "請填寫社群名稱。";
        return;
      }

      submitStatus.textContent = "送出中…";

      try {
        await fetch(SCRIPT_URL, {
          method: "POST",
          mode: "no-cors",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ orderId, snsName })
        });

        submitStatus.textContent = "✅ 已送出報名，感謝參加！";
        form.reset();
        orderStatus.textContent = "";
      } catch (err) {
        console.error(err);
        submitStatus.textContent = "送出時發生錯誤，請稍後再試。";
      }
    });
  </script>
</body>
</html>
